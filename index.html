<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Stock & Sales Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
        }
        /* Custom scrollbar for large tables */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* Slate-400 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #e2e8f0; /* Slate-200 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl p-4 md:p-10">
        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-6 border-b-4 border-indigo-200 pb-3">
            Mobile Accessories Inventory System
        </h1>

        <!-- Tabs Navigation -->
        <div class="flex flex-wrap gap-1 md:gap-4 border-b border-gray-200 mb-8">
            <button id="tab-add" class="tab-button active-tab">
                Stock & Operations
            </button>
            <button id="tab-sales" class="tab-button inactive-tab">
                Sales History (Sold Items)
            </button>
            <button id="tab-data" class="tab-button inactive-tab ml-auto">
                Data Management (Backup)
            </button>
        </div>

        <!-- Styles for Tabs -->
        <style>
            .tab-button {
                @apply py-3 px-4 text-sm font-semibold transition duration-200 ease-in-out;
            }
            .active-tab {
                @apply border-b-4 border-indigo-600 text-indigo-700 bg-indigo-50 rounded-t-lg;
            }
            .inactive-tab {
                @apply text-gray-600 hover:text-indigo-700 hover:border-b-4 hover:border-indigo-100 border-b-4 border-transparent;
            }
            .input-field {
                @apply p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150;
            }
            .table-header {
                @apply px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider;
            }
        </style>

        <!-- Tab Content: Add Stock & Current Stock List -->
        <div id="content-add" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-700 mb-5">Add New Stock</h2>
            <form id="stock-form" class="grid grid-cols-4 md:grid-cols-6 gap-4 bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200 mb-8">
                <input type="text" id="code" placeholder="Code (e.g., CC001)" class="input-field col-span-4 md:col-span-1" required>
                <input type="text" id="group" placeholder="Product Group (e.g., Charger)" class="input-field col-span-4 md:col-span-2" required>
                <input type="text" id="name" placeholder="Product Name" class="input-field col-span-4 md:col-span-1" required>
                <input type="number" id="quantity" placeholder="Quantity" min="1" class="input-field col-span-2 md:col-span-1" required>
                <input type="number" id="rate" placeholder="Rate (e.g., 500.00)" min="0.01" step="0.01" class="input-field col-span-2 md:col-span-1" required>
                <button type="submit" class="col-span-4 md:col-span-6 lg:col-span-6 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 shadow-lg transition duration-150 transform hover:scale-[1.01] font-semibold">
                    Add Item to Stock
                </button>
            </form>

            <!-- Current Stock List Moved Here -->
            <h2 class="text-2xl font-bold text-gray-700 mb-5 mt-8 border-t pt-6">Current Remaining Stock</h2>
            <div id="current-stock-container" class="overflow-x-auto custom-scrollbar bg-white rounded-xl shadow-md p-2">
                <!-- Stock list will be rendered here -->
            </div>
            <div class="text-right mt-6">
                <button onclick="printReport('stock')" class="bg-green-600 text-white py-3 px-6 rounded-xl hover:bg-green-700 transition duration-150 shadow-md font-medium flex items-center float-right">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3h10V4a2 2 0 00-2-2H7a2 2 0 00-2 2zM3 7h14v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7zm5 4a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    Print Stock List
                </button>
            </div>
        </div>

        <!-- Tab Content: Sales History (Previous content-sales) -->
        <div id="content-sales" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-5">Sales History (Sold Items)</h2>

            <!-- Date Filters for Sales -->
            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-gray-100 rounded-xl shadow-inner border border-gray-200">
                <span class="font-medium text-gray-700">Filter by Date:</span>
                <input type="date" id="start-date" class="input-field w-auto" title="Start Date">
                <input type="date" id="end-date" class="input-field w-auto" title="End Date">
                <button onclick="renderSales()" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 font-medium">
                    Apply Filter
                </button>
                <button onclick="printReport('sales')" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150 font-medium ml-auto flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3h10V4a2 2 0 00-2-2H7a2 2 0 00-2 2zM3 7h14v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7zm5 4a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    Print Sales List
                </button>
            </div>

            <div id="sales-history-container" class="overflow-x-auto custom-scrollbar bg-white rounded-xl shadow-md p-2">
                <!-- Sales list will be rendered here -->
            </div>
        </div>
        
        <!-- Tab Content: Data Management -->
        <div id="content-data" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-5">Data Backup & Restore</h2>
            <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-300 space-y-6">
                <p class="text-base text-yellow-800">
                    *Your data is saved in your browser's local storage. Exporting (Backup) is crucial for safety and transferring data to another device.
                </p>
                <!-- Export Data -->
                <button onclick="exportData()" class="bg-orange-600 text-white py-3 px-6 rounded-xl hover:bg-orange-700 transition duration-150 shadow-lg font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm-3 8a3 3 0 116 0h1a4 4 0 10-8 0h1zm-1 2h8v2H6v-2z" /></svg>
                    Export Data (Download Backup)
                </button>

                <!-- Import Data -->
                <div class="pt-6 border-t border-yellow-200">
                    <p class="font-bold text-gray-700 mb-3 text-lg">Import Data (Restore)</p>
                    <input type="file" id="import-file" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200" />
                    <button onclick="importData()" class="mt-4 bg-indigo-600 text-white py-3 px-6 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg font-semibold flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Import and Restore
                    </button>
                    <p id="import-message" class="mt-3 text-sm font-medium text-red-600 hidden"></p>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Message Modal for confirmations/alerts -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center transform transition-transform duration-300 scale-100">
            <p id="modal-text" class="text-xl font-medium text-gray-800 mb-6"></p>
            <div id="modal-custom-content">
                <!-- Custom content like input field for selling will be inserted here -->
            </div>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-confirm" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150 font-medium hidden">
                    Yes
                </button>
                <button id="modal-cancel" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-150 font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        // Global data arrays for stock and sales
        let stockItems = [];
        let salesItems = [];
        let nextStockId = 1; // Unique ID for stock items
        let nextSaleId = 1;  // Unique ID for sales entries

        // --- Utility Functions ---

        /**
         * Custom Modal/Message Box (Replaces alert() and confirm())
         * @param {string} message - Message to display.
         * @param {function | null} onConfirm - Function to run on confirm (for confirmation dialogs).
         * @param {HTMLElement | null} customContent - Optional custom element to insert into the modal.
         */
        function showMessage(message, onConfirm = null, customContent = null) {
            const modal = document.getElementById('message-modal');
            const modalTextElement = document.getElementById('modal-text');
            const confirmButton = document.getElementById('modal-confirm');
            const cancelButton = document.getElementById('modal-cancel');
            const customContentDiv = document.getElementById('modal-custom-content');
            
            // Clear any previous custom elements
            customContentDiv.innerHTML = '';

            modalTextElement.textContent = message;

            // Insert custom content if provided
            if (customContent) {
                customContentDiv.appendChild(customContent);
            }

            // Reset event listeners and visibility
            confirmButton.onclick = null;
            confirmButton.classList.add('hidden');
            cancelButton.textContent = 'Close';
            cancelButton.onclick = () => modal.classList.add('hidden');

            if (onConfirm) {
                confirmButton.classList.remove('hidden');
                cancelButton.textContent = 'Cancel'; // Changed to Cancel for confirmation flow

                confirmButton.onclick = () => {
                    // Check if the custom content (if any) is still there before proceeding
                    if (customContent && !customContentDiv.contains(customContent)) {
                        console.error("Custom content missing, preventing confirmation.");
                        return; 
                    }
                    modal.classList.add('hidden');
                    onConfirm();
                };
            }
            
            modal.classList.remove('hidden');
        }

        /**
         * Loads data from Local Storage.
         */
        function loadData() {
            try {
                const stockData = localStorage.getItem('shop_stock_items');
                const salesData = localStorage.getItem('shop_sales_items');
                const stockId = localStorage.getItem('shop_next_stock_id');
                const saleId = localStorage.getItem('shop_next_sale_id');

                if (stockData) {
                    stockItems = JSON.parse(stockData);
                }
                if (salesData) {
                    salesItems = JSON.parse(salesData);
                }
                if (stockId) {
                    nextStockId = parseInt(stockId);
                }
                if (saleId) {
                    nextSaleId = parseInt(saleId);
                }
            } catch (e) {
                console.error("Error loading data from local storage:", e);
                // Non-critical error, continue with empty data
            }
            renderStock();
            renderSales();
        }

        /**
         * Saves data to Local Storage.
         */
        function saveData() {
            try {
                localStorage.setItem('shop_stock_items', JSON.stringify(stockItems));
                localStorage.setItem('shop_sales_items', JSON.stringify(salesItems));
                localStorage.setItem('shop_next_stock_id', nextStockId.toString());
                localStorage.setItem('shop_next_sale_id', nextSaleId.toString());
            } catch (e) {
                console.error("Error saving data to local storage:", e);
                showMessage("Error saving data. Local storage might be full.");
            }
        }

        // --- Core Application Logic ---

        /**
         * Adds a new stock item.
         */
        document.getElementById('stock-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('code').value.trim();
            const group = document.getElementById('group').value.trim();
            const name = document.getElementById('name').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const rate = parseFloat(document.getElementById('rate').value);

            if (!code || !group || !name || isNaN(quantity) || quantity <= 0 || isNaN(rate) || rate <= 0) {
                showMessage("Please fill all fields correctly (Quantity and Rate must be positive numbers).");
                return;
            }

            const amount = quantity * rate;
            
            // Auto-increment S.No (id)
            const newItem = {
                id: nextStockId++, // unique ID
                code,
                group,
                name,
                quantity,
                rate,
                amount: parseFloat(amount.toFixed(2)),
                date: new Date().toISOString()
            };

            stockItems.push(newItem);
            
            saveData();
            renderStock(); // RENDER STOCK IMMEDIATELY AFTER ADDING
            
            // Form reset
            this.reset();
            document.getElementById('code').focus();
            
            showMessage(`Stock item '${name}' added successfully! Quantity: ${quantity}`);
        });

        /**
         * Marks an item as sold from the current stock.
         * @param {number} itemId - Stock item's unique ID.
         */
        function sellItem(itemId) {
            const stockIndex = stockItems.findIndex(item => item.id === itemId);
            if (stockIndex === -1) {
                showMessage("Item not found in stock.");
                return;
            }

            const item = stockItems[stockIndex];
            
            // 1. Create the input field for quantity
            const sellQtyInput = document.createElement('input');
            sellQtyInput.type = 'number';
            sellQtyInput.min = '1';
            sellQtyInput.max = item.quantity.toString();
            sellQtyInput.value = item.quantity.toString();
            sellQtyInput.id = 'sell-quantity-input';
            sellQtyInput.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-lg', 'mb-6', 'text-center', 'font-medium', 'text-lg');

            // 2. Set the message
            const message = `Enter the quantity to sell for '${item.name}' (Available: ${item.quantity})`;
            
            // 3. Define the confirmation logic
            const onConfirmSale = () => {
                const inputElement = document.getElementById('sell-quantity-input');
                // Check if element exists before reading value, safety check
                if (!inputElement) return; 

                const sellQuantity = parseInt(inputElement.value);

                // Validation
                if (isNaN(sellQuantity) || sellQuantity <= 0) {
                    // Re-show message if validation fails
                    showMessage("Invalid quantity. Please enter a positive number.", onConfirmSale, sellQtyInput);
                    return;
                }
                
                if (sellQuantity > item.quantity) {
                    // Re-show message if validation fails
                    showMessage(`Sale quantity cannot be more than available stock (${item.quantity}).`, onConfirmSale, sellQtyInput);
                    return;
                }

                // 4. Process Sale
                // a. Add to Sales List
                const soldItem = {
                    id: nextSaleId++, // unique sale ID
                    code: item.code,
                    group: item.group,
                    name: item.name,
                    quantity: sellQuantity,
                    rate: item.rate,
                    amount: parseFloat((sellQuantity * item.rate).toFixed(2)),
                    saleDate: new Date().toISOString()
                };
                salesItems.push(soldItem);

                // b. Reduce stock quantity
                item.quantity -= sellQuantity;
                item.amount = parseFloat((item.quantity * item.rate).toFixed(2));
                
                let successMessage = '';

                // c. Remove item from stock if quantity hits zero
                if (item.quantity === 0) {
                    stockItems.splice(stockIndex, 1);
                    successMessage = `Sold ${sellQuantity} units of '${item.name}'. Item removed from stock.`;
                } else {
                    successMessage = `Sold ${sellQuantity} units of '${item.name}'. Remaining stock: ${item.quantity}.`;
                }
                
                // d. Save and Render
                saveData();
                renderStock();
                renderSales();

                // e. Show final confirmation message (without input or confirm button)
                showMessage(successMessage);
            };

            // Temporarily change Confirm button text for clarity
            document.getElementById('modal-confirm').textContent = 'Confirm Sale';
            
            // Show the modal with custom input and confirmation logic
            showMessage(message, onConfirmSale, sellQtyInput);
            sellQtyInput.focus(); // Focus on the input field
        }


        /**
         * Deletes an item from stock or sales list.
         * @param {'stock'|'sales'} type - List name.
         * @param {number} itemId - Item's unique ID.
         */
        function deleteItem(type, itemId) {
            const list = type === 'stock' ? stockItems : salesItems;
            const listName = type === 'stock' ? 'Stock' : 'Sales';
            const index = list.findIndex(item => item.id === itemId);
            const itemName = list[index] ? list[index].name : 'Item'; // Get name before potentially deleting it

            if (index === -1) {
                showMessage(`Item not found in ${listName} list.`);
                return;
            }

            showMessage(`Are you sure you want to delete '${itemName}' permanently from the ${listName} list? This action cannot be undone.`, () => {
                list.splice(index, 1);
                
                saveData();
                if (type === 'stock') {
                    renderStock();
                } else {
                    renderSales();
                }
                showMessage(`'${itemName}' successfully deleted from ${listName}.`);
            });
        }

        // --- Rendering Functions ---

        /**
         * Renders the current stock list.
         */
        function renderStock() {
            const container = document.getElementById('current-stock-container');
            
            // Re-calculate display serial numbers
            stockItems.forEach((item, i) => { item.serial = i + 1; });

            if (stockItems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8 text-lg font-medium">No items currently in stock. Use the form above to add an item.</p>';
                return;
            }

            let totalAmount = 0;
            const tableRows = stockItems.map((item) => {
                totalAmount += item.amount;
                return `
                    <tr class="border-b hover:bg-indigo-50 transition duration-100">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${item.serial}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">${item.code}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${item.group}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${item.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-red-600">${item.quantity}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">$${item.rate.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-green-700">$${item.amount.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="sellItem(${item.id})" class="text-xs bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-full transition duration-150 shadow-md">
                                Sell
                            </button>
                            <button onclick="deleteItem('stock', ${item.id})" class="text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-full transition duration-150 shadow-md">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="table-header w-12">S. No.</th>
                            <th class="table-header">Code</th>
                            <th class="table-header">Group</th>
                            <th class="table-header">Product Name</th>
                            <th class="table-header">Quantity</th>
                            <th class="table-header">Rate</th>
                            <th class="table-header">Amount</th>
                            <th class="table-header text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        ${tableRows}
                    </tbody>
                    <tfoot>
                        <tr class="bg-indigo-200 border-t-4 border-indigo-400">
                            <td colspan="6" class="px-4 py-3 text-right text-lg font-bold text-gray-800">TOTAL STOCK VALUE:</td>
                            <td class="px-4 py-3 whitespace-nowrap text-lg font-bold text-gray-800">$${totalAmount.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            `;
        }

        /**
         * Renders the sales history list (filtered by date).
         */
        function renderSales() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const container = document.getElementById('sales-history-container');
            
            // Filter sales items
            let filteredSales = salesItems;
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date(0);
                const end = endDate ? new Date(endDate) : new Date();
                if (endDate) end.setDate(end.getDate() + 1); // Include the end date fully

                filteredSales = salesItems.filter(item => {
                    const saleDate = new Date(item.saleDate);
                    return saleDate >= start && saleDate < end;
                });
            }

            // Re-calculate display serial numbers for the filtered list
            filteredSales.forEach((item, i) => { item.serial = i + 1; });

            if (filteredSales.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8 text-lg font-medium">No sales recorded in the selected date range.</p>';
                return;
            }

            let totalSaleAmount = 0;
            const tableRows = filteredSales.map(item => {
                totalSaleAmount += item.amount;
                // Format date for display
                const saleDate = new Date(item.saleDate).toLocaleDateString('en-GB', {year: 'numeric', month: 'short', day: 'numeric'});
                return `
                    <tr class="border-b hover:bg-red-50 transition duration-100">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${item.serial}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800">${saleDate}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${item.code}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${item.group}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600">${item.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-red-600">${item.quantity}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">$${item.rate.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-green-700">$${item.amount.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteItem('sales', ${item.id})" class="text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-full transition duration-150 shadow-md">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-red-100">
                        <tr>
                            <th class="table-header w-12">S. No.</th>
                            <th class="table-header">Date</th>
                            <th class="table-header">Code</th>
                            <th class="table-header">Group</th>
                            <th class="table-header">Product Name</th>
                            <th class="table-header">Qty Sold</th>
                            <th class="table-header">Rate</th>
                            <th class="table-header">Amount</th>
                            <th class="table-header text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        ${tableRows}
                    </tbody>
                    <tfoot>
                        <tr class="bg-red-200 border-t-4 border-red-400">
                            <td colspan="7" class="px-4 py-3 text-right text-lg font-bold text-gray-800">TOTAL SALE AMOUNT IN FILTER:</td>
                            <td class="px-4 py-3 whitespace-nowrap text-lg font-bold text-gray-800">$${totalSaleAmount.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            `;
        }


        // --- Reporting / Printing Function ---

        /**
         * Prints the stock or sales list (filtered by date if sales).
         * @param {'stock'|'sales'} type - Which list to print.
         */
        function printReport(type) {
            let dataToPrint = [];
            let reportTitle = '';
            let dateRange = '';
            let grandTotal = 0;

            if (type === 'stock') {
                dataToPrint = stockItems.map((item, index) => ({...item, serial: index + 1}));
                reportTitle = 'Current Remaining Stock List';
                dateRange = `Date Generated: ${new Date().toLocaleDateString('en-GB')}`;
            } else if (type === 'sales') {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                const start = startDate ? new Date(startDate) : new Date(0);
                const end = endDate ? new Date(endDate) : new Date();
                if (endDate) end.setDate(end.getDate() + 1);

                dataToPrint = salesItems.filter(item => {
                    const saleDate = new Date(item.saleDate);
                    return saleDate >= start && saleDate < end;
                }).map((item, index) => ({
                    ...item, 
                    serial: index + 1, 
                    saleDate: new Date(item.saleDate).toLocaleDateString('en-GB', {year: 'numeric', month: 'short', day: 'numeric'})
                }));

                reportTitle = 'Sales History Report (Sold Items)';
                dateRange = `Period: ${startDate || 'Start'} to ${endDate || 'Today'}`;
            }

            if (dataToPrint.length === 0) {
                showMessage("No data to print for this selection.");
                return;
            }

            // HTML content for printing
            let printContent = `
                <div class="print-container p-4">
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">${reportTitle}</h1>
                    <p style="font-size: 0.875rem; margin-bottom: 1rem;">${dateRange}</p>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                        <thead>
                            <tr style="background-color: #e0e0e0; text-align: left;">
                                <th style="border: 1px solid #ccc; padding: 6px;">S.No.</th>
                                ${type === 'sales' ? '<th style="border: 1px solid #ccc; padding: 6px;">Date</th>' : ''}
                                <th style="border: 1px solid #ccc; padding: 6px;">Code</th>
                                <th style="border: 1px solid #ccc; padding: 6px;">Group</th>
                                <th style="border: 1px solid #ccc; padding: 6px;">Name</th>
                                <th style="border: 1px solid #ccc; padding: 6px;">Qty</th>
                                <th style="border: 1px solid #ccc; padding: 6px;">Rate</th>
                                <th style="border: 1px solid #ccc; padding: 6px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            dataToPrint.forEach(item => {
                grandTotal += item.amount;
                printContent += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 6px;">${item.serial}</td>
                        ${type === 'sales' ? `<td style="border: 1px solid #ccc; padding: 6px;">${item.saleDate}</td>` : ''}
                        <td style="border: 1px solid #ccc; padding: 6px;">${item.code}</td>
                        <td style="border: 1px solid #ccc; padding: 6px;">${item.group}</td>
                        <td style="border: 1px solid #ccc; padding: 6px;">${item.name}</td>
                        <td style="border: 1px solid #ccc; padding: 6px;">${item.quantity}</td>
                        <td style="border: 1px solid #ccc; padding: 6px;">$${item.rate.toFixed(2)}</td>
                        <td style="border: 1px solid #ccc; padding: 6px;">$${item.amount.toFixed(2)}</td>
                    </tr>
                `;
            });

            printContent += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f0f0f0;">
                                <td colspan="${type === 'sales' ? 7 : 6}" style="border: 1px solid #ccc; padding: 6px; text-align: right; font-weight: bold;">GRAND TOTAL:</td>
                                <td style="border: 1px solid #ccc; padding: 6px; font-weight: bold;">$${grandTotal.toFixed(2)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            // Open a new window for printing
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>' + reportTitle + '</title>');
            printWindow.document.write('<style>body{font-family: Inter, sans-serif;} @media print { button, .no-print { display: none; } }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        }

        // --- Data Management (Import/Export) ---

        /**
         * Exports data to a JSON file (Backup).
         */
        function exportData() {
            const dataToExport = {
                stockItems: stockItems,
                salesItems: salesItems,
                nextStockId: nextStockId,
                nextSaleId: nextSaleId,
                exportedAt: new Date().toISOString()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Shop_Inventory_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            
            // Click the link to start download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage("Data backup file downloaded successfully.");
        }

        /**
         * Imports data from a JSON file and restores it.
         */
        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            const messageElement = document.getElementById('import-message');
            messageElement.classList.add('hidden');

            if (!file) {
                messageElement.textContent = "Please select a JSON backup file to import.";
                messageElement.classList.remove('hidden');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedData.stockItems) || !Array.isArray(importedData.salesItems) || importedData.nextStockId === undefined || importedData.nextSaleId === undefined) {
                         throw new Error("Invalid data format. File structure is incorrect.");
                    }

                    // Confirm before overwriting
                    showMessage("Are you sure you want to restore data? This will overwrite your current inventory.", () => {
                        // Restore data
                        stockItems = importedData.stockItems;
                        salesItems = importedData.salesItems;
                        nextStockId = parseInt(importedData.nextStockId);
                        nextSaleId = parseInt(importedData.nextSaleId);
                        
                        // Recalculate all display serials (important for continuous numbering)
                        stockItems.forEach((item, i) => { item.serial = i + 1; });
                        salesItems.forEach((item, i) => { item.serial = i + 1; });

                        saveData();
                        renderStock();
                        renderSales();
                        
                        fileInput.value = ''; // Clear file input
                        showMessage("Data successfully restored! (Imported data saved to local storage)");
                    });

                } catch (e) {
                    console.error("Data import error:", e);
                    messageElement.textContent = `Data restore failed: ${e.message}. Check console for details.`;
                    messageElement.classList.remove('hidden');
                }
            };
            reader.readAsText(file);
        }

        // --- Event Listeners and Initialization ---
        
        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active styling from all buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active-tab');
                    btn.classList.add('inactive-tab');
                });

                // Hide all content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                // Add active styling to clicked button
                this.classList.add('active-tab');
                this.classList.remove('inactive-tab');

                // Show corresponding content
                const contentId = 'content-' + this.id.split('-')[1];
                document.getElementById(contentId).classList.remove('hidden');

                // Re-render lists when switching
                if (contentId === 'content-add') {
                    renderStock();
                } else if (contentId === 'content-sales') {
                    renderSales();
                }
            });
        });

        // Initialize App
        window.onload = loadData;
    </script>
</body>
</html>
